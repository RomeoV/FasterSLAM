image: romeov/fasterslam_docker

stages:
  - build
  - test
  - coverage

system_info:
  stage: build
  script:
  - g++ -E -march=native -dM - < /dev/null | grep -i avx || true
  - g++ -E -march=native -dM - < /dev/null | grep -i fma || true

build:
  stage: build
  script:
    - mkdir src/build -p
    - cmake -S src -B src/build -DTEST_COVERAGE=On -DCMAKE_CXX_FLAGS="-mavx"
    - cmake --build src/build -j 2
  artifacts:
    paths:
      - src/build

build_release:
  stage: build
  script:
    - mkdir src/build_release -p
    - cmake -S src -B src/build_release -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-mavx"
    - cmake --build src/build_release -j 2
  artifacts:
    paths:
      - src/build_release

unittests:
  stage: test
  script:
    - make test -C src/build
  artifacts:
    paths:
      - src/build
  dependencies:
    - build

valgrind:
  stage: test
  script:
    - cd src/build
    - ctest . -T memcheck --overwrite MemoryCheckCommandOptions="--leak-check=full --error-exitcode=1"
  dependencies:
    - build

benchmarks:
  stage: test
  script:
    - make -C src/build_release benchmarks
  dependencies:
    - build_release

coverage:
  stage: coverage
  script:
    - make coverage -C src/build
  dependencies:
    - unittests
